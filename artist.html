
<html>
  <head>

    <link rel="stylesheet" href="css/artist.css"/>
    <script src="js/jsUtils.js"></script>
    <script src="js/MochiKit/MochiKit.js"></script>
    <script src="js/sendJSONPRequest.js"></script>
  
    <script src="js/jquery.js"></script>
  
    <script src="js/Mushub/dependencies.js"></script>
    
    <script>
   
    //Stolen from jsUtils    

   function QueryString(qs){
      this.parts = {};
      var self = this;
      
      if(qs.indexOf("?")==0){
        qs = qs.substring(1);
      } 
      
      qs.split("&").forEach(function(pair){
        var bits = pair.split("=");
        self.parts[bits[0]] = decodeURIComponent(bits[1]);
      });

    }

    QueryString.fromLocation = function(){
      return new QueryString(window.location.search);
    }   
   
   </script>
    
   <script>
    function showArtistUI(artist_name, artist_mbid){
      $(document.body).removeClass("search");
      $(document.body).addClass("artist");
      $("#search_input").attr("disabled", false);  
      var artist = Artist.findByNameAndMBid(artist_name, artist_mbid);
      var ui = new ArtistUI($('#artist_ui'), artist);
      ui.addContent("Biography", new mushub.ui.panels.WikipediaBiographyPanel(artist), {});
      ui.addContent("Top Albums", new mushub.ui.panels.LastfmTopAlbumsPanel(artist), {});
      ui.addContent("Similar Artists", new mushub.ui.panels.LastfmSimilarArtistsPanel(artist), {});
      ui.addContent("Links", new mushub.ui.panels.MusicbrainzLinksPanel(artist), {});
      ui.writeHTML();
    }
    
    function performQuery(query){
        $("#search_input").attr("value", query);
        $("#search_input").attr("disabled", true);        
        var search = new ArtistQuery(query);
        search.musicbrainz_search.connect("endUpdate", this, function(){
          var results = search.musicbrainz_search.search_results();
          if(results.length >0){
            var result = results[0];
            var artist_name = result.artist_name;
            var artist_mbid = result.artist_mbid;
            window.location.search = "?artist_name="+encodeURIComponent(artist_name)+"&artist_mbid="+artist_mbid;
           //showArtistUI(artist_name, artist_mbid);
          }
//          alert("Results "  + results.toSource());
        });
        search.musicbrainz_search.update();
    }
   
    var params = QueryString.fromLocation().parts;
    console.log("Params : %o", params);
    if(params.artist_name && params.artist_mbid){
      console.log("Show Artist");
      var artist_name = params.artist_name;
      var artist_mbid = params.artist_mbid;
      $(document).ready(function(){
          showArtistUI(artist_name, artist_mbid);
      });  
    }else if(params.artist_name || params.query){
      console.log("Searching...");
      var query = params.artist_name || params.query;
      $(document).ready(function(){
        performQuery(query);
      });
    }else{
      console.log("Startup..");
    }
    
    function searchSubmit(){
      var query = $('#search_input').val();
      performQuery(query);
      return false;
    }
    
    </script>

  </head>
    <body class="search">

    <div id="top_bar">
      <a href="artist.html" class="logo"><img class="logo" src="images/logo.png" width="100" height="30" alt="mushub"/></a>
      <form action="#" method="GET" onsubmit="return searchSubmit();">
        <input type="text" name="query" class="search" id="search_input"></input>
        <input type="submit" name="search" value="search" class="submit"></input>
      </form>
    </div>
    
    <div id="artist_ui"></div>
  
  </body>
</html>
